{% extends "layout.html" %}
{% block content %}
  <h2>Bulk Import</h2>
  {% if error_message %}<div class="alert alert-danger">{{ error_message }}</div>{% endif %}
  {% if success_message %}<div class="alert alert-success">{{ success_message }}</div>{% endif %}

  <form method="post" enctype="multipart/form-data" id="importForm">
    <div class="mb-3">
      <label class="form-label">File</label>
      <input class="form-control" type="file" name="jsonl_file" id="jsonlFile" accept=".jsonl,.json,application/x-ndjson" required>
      <button type="button" class="btn btn-info btn-sm mt-2" id="analyzeBtn" style="display:none;">Analyze File & Show Available Keys</button>
    </div>

    <div id="fieldMappings" style="display:none;">
      <h5>Field Mappings</h5>
      <div class="alert alert-info">
        <strong>Available keys in your file:</strong> <span id="availableKeys"></span>
      </div>
      
      <div class="row">
        <div class="col">
           <label class="form-label">content_field(s)*</label>
           <select class="form-select" name="content_field" id="contentField" multiple size="4" required>
             <option value="" disabled>Select field(s) to translate...</option>
           </select>
           <small class="form-text text-muted">Hold Ctrl/Cmd to select multiple fields. Each selected field will create separate translation tasks.</small>
           <textarea class="form-control mt-1" name="content_field_custom" placeholder="Or type custom paths, one per line:\nfield1\nfield2\ndata.nested.field" rows="3" style="display:none;"></textarea>
         </div>
        <div class="col">
          <label class="form-label">title_field</label>
          <select class="form-select" name="title_field" id="titleField">
            <option value="">Select a field...</option>
          </select>
          <input class="form-control mt-1" name="title_field_custom" placeholder="Or type custom path" style="display:none;">
        </div>
        <div class="col">
          <label class="form-label">description_field</label>
          <select class="form-select" name="description_field" id="descriptionField">
            <option value="">Select a field...</option>
          </select>
          <input class="form-control mt-1" name="description_field_custom" placeholder="Or type custom path" style="display:none;">
        </div>
      </div>
      <div class="row mt-2">
        <div class="col">
          <label class="form-label">source_language_field</label>
          <select class="form-select" name="source_language_field" id="sourceLanguageField">
            <option value="">Select a field...</option>
          </select>
          <input class="form-control mt-1" name="source_language_field_custom" placeholder="Or type custom path" style="display:none;">
        </div>
        <div class="col">
          <label class="form-label">target_language_field</label>
          <select class="form-select" name="target_language_field" id="targetLanguageField">
            <option value="">Select a field...</option>
          </select>
          <input class="form-control mt-1" name="target_language_field_custom" placeholder="Or type custom path" style="display:none;">
        </div>
        <div class="col">
          <label class="form-label">reward_amount_field</label>
          <select class="form-select" name="reward_amount_field" id="rewardAmountField">
            <option value="">Select a field...</option>
          </select>
          <input class="form-control mt-1" name="reward_amount_field_custom" placeholder="Or type custom path" style="display:none;">
        </div>
      </div>
      
      <div class="mt-2">
        <button type="button" class="btn btn-link btn-sm" id="toggleCustomInputs">Show custom input fields</button>
      </div>
    </div>

      <h5 class="mt-3">Default Values</h5>
      <div class="row">
        <div class="col"><label class="form-label">default_source_language</label><input class="form-control" name="default_source_language" value="english"></div>
        <div class="col"><label class="form-label">default_target_language</label><input class="form-control" name="default_target_language"></div>
        <div class="col"><label class="form-label">default_task_type</label><input class="form-control" name="default_task_type" value="text_translation"></div>
        <div class="col"><label class="form-label">default_reward_amount</label><input class="form-control" type="number" step="0.01" name="default_reward_amount"></div>
      </div>

      <button class="btn btn-success mt-3" type="submit">Import</button>
    </div>
  </form>

  {% if import_results %}
    <hr>
    <h5>Import Results</h5>
    <div class="alert alert-info">
      <strong>{{ import_results.message }}</strong>
    </div>
    {% if import_results %}
       <div class="row mt-2">
         <div class="col-md-6">
           <strong>Import Summary:</strong>
           <ul>
             <li>Total rows processed: {{ import_results.total_rows }}</li>
             <li>Content fields selected: {{ import_results.content_fields_count }} ({{ import_results.content_fields | join(', ') }})</li>
             <li>Tasks created: {{ import_results.success_count }}</li>
             <li>Tasks failed: {{ import_results.error_count }}</li>
           </ul>
         </div>
       </div>
       <h6>Sample Processed Data (First 3 items):</h6>
       <pre>{{ import_results.sample_processed_data | tojson() }}</pre>
     {% endif %}
    {% if import_results.errors %}
      <h6>Errors:</h6>
      <ul>
        {% for error in import_results.errors %}
          <li class="text-danger">{{ error }}</li>
        {% endfor %}
      </ul>
    {% endif %}
  {% endif %}

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const fileInput = document.getElementById('jsonlFile');
      const analyzeBtn = document.getElementById('analyzeBtn');
      const fieldMappings = document.getElementById('fieldMappings');
      const toggleCustomInputs = document.getElementById('toggleCustomInputs');
      const availableKeys = document.getElementById('availableKeys');
      
      let customInputsVisible = false;
      
      // Show analyze button when file is selected
      fileInput.addEventListener('change', function() {
        if (this.files.length > 0) {
          analyzeBtn.style.display = 'block';
          fieldMappings.style.display = 'none';
        } else {
          analyzeBtn.style.display = 'none';
          fieldMappings.style.display = 'none';
        }
      });
      
      // Analyze file and extract keys
      analyzeBtn.addEventListener('click', function() {
        const file = fileInput.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const content = e.target.result;
            const lines = content.trim().split('\n');
            const allKeys = new Set();
            
            // Parse first few lines to get available keys
            for (let i = 0; i < Math.min(lines.length, 10); i++) {
              if (lines[i].trim()) {
                const item = JSON.parse(lines[i]);
                extractKeys(item, '', allKeys);
              }
            }
            
            const keyArray = Array.from(allKeys).sort();
            populateDropdowns(keyArray);
            availableKeys.textContent = keyArray.join(', ');
            fieldMappings.style.display = 'block';
            
          } catch (error) {
            alert('Error parsing file: ' + error.message);
          }
        };
        reader.readAsText(file);
      });
      
      // Extract all keys from nested objects
      function extractKeys(obj, prefix, keySet) {
        for (const key in obj) {
          if (obj.hasOwnProperty(key)) {
            const fullKey = prefix ? `${prefix}.${key}` : key;
            keySet.add(fullKey);
            
            if (typeof obj[key] === 'object' && obj[key] !== null && !Array.isArray(obj[key])) {
              extractKeys(obj[key], fullKey, keySet);
            }
          }
        }
      }
      
      // Populate all dropdown selects
      function populateDropdowns(keys) {
        const selects = ['contentField', 'titleField', 'descriptionField', 'sourceLanguageField', 'targetLanguageField', 'rewardAmountField'];
        
        selects.forEach(selectId => {
          const select = document.getElementById(selectId);
          // Clear existing options except the first one
          while (select.children.length > 1) {
            select.removeChild(select.lastChild);
          }
          
          // Add new options
          keys.forEach(key => {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = key;
            select.appendChild(option);
          });
        });
      }
      
      // Toggle custom input fields
      toggleCustomInputs.addEventListener('click', function() {
        customInputsVisible = !customInputsVisible;
        const customInputs = document.querySelectorAll('input[name$="_custom"]');
        
        customInputs.forEach(input => {
          input.style.display = customInputsVisible ? 'block' : 'none';
        });
        
        this.textContent = customInputsVisible ? 'Hide custom input fields' : 'Show custom input fields';
      });
      
      // Handle form submission - use custom input if provided, otherwise use dropdown value
       document.getElementById('importForm').addEventListener('submit', function(e) {
         const fields = ['title_field', 'description_field', 'source_language_field', 'target_language_field', 'reward_amount_field'];
         
         // Handle content_field specially (multiple selection or custom textarea)
         const contentSelect = document.querySelector('select[name="content_field"]');
         const contentCustom = document.querySelector('textarea[name="content_field_custom"]');
         
         if (contentCustom && contentCustom.value.trim()) {
           // Clear select and create hidden inputs for custom values
           contentSelect.innerHTML = '';
           const customFields = contentCustom.value.trim().split('\n').filter(f => f.trim());
           customFields.forEach(field => {
             const option = document.createElement('option');
             option.value = field.trim();
             option.selected = true;
             contentSelect.appendChild(option);
           });
         }
         
         // Handle other single-select fields
         fields.forEach(field => {
           const select = document.querySelector(`select[name="${field}"]`);
           const customInput = document.querySelector(`input[name="${field}_custom"]`);
           
           if (customInput && customInput.value.trim()) {
             // Use custom input value
             select.value = customInput.value.trim();
           }
         });
       });
    });
  </script>
{% endblock %}