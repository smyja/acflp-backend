#!/usr/bin/env bash
set -euo pipefail

# Try to activate local venv if present
REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
if [ -f "$REPO_ROOT/.venv/bin/activate" ]; then
  # shellcheck disable=SC1091
  . "$REPO_ROOT/.venv/bin/activate" || true
fi

# Prefer pre-commit if available
if command -v pre-commit >/dev/null 2>&1; then
  exec pre-commit run --hook-stage pre-commit "$@"
fi

echo "[githooks] pre-commit not found; falling back to Ruff on staged Python files" >&2

CHANGED_PY=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.py$' || true)
if [ -z "$CHANGED_PY" ]; then
  exit 0
fi

if ! command -v ruff >/dev/null 2>&1; then
  echo "[githooks] Ruff is not installed. Run 'make install-dev' to install dev tools." >&2
  exit 1
fi

echo "$CHANGED_PY" | xargs ruff check --fix
echo "$CHANGED_PY" | xargs ruff format
# Restage updated files
echo "$CHANGED_PY" | xargs git add

exit 0
